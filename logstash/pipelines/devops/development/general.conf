input {
    jdbc {
        jdbc_driver_class => "com.microsoft.sqlserver.jdbc.SQLServerDriver"
        jdbc_connection_string => "jdbc:sqlserver://192.168.159.78:1433;database=CSDEVOPS11DEV_LOG;user=usrElastic;password=pwdElastic;loginTimeout=30;"
        jdbc_user => nil
        last_run_metadata_path => "/var/opt/elastic/logstash/run/devops/development/general.last_run"
        schedule => "*/5 * * * *"

        jdbc_paging_enabled => true
        tracking_column => "instant_unix"
        use_column_value => true
        tracking_column_type => "numeric"

        statement => "
            SELECT
                instant_unix                = DATEDIFF(SECOND,'2020-01-01', instant),
                application_action_name     = g.[Action_Name],
                application_key             = g.[Application_Key],
                application_name            = g.[Application_Name],
                client_ip                   = g.[Client_IP],
                application_entrypoint_name = g.[Entrypoint_Name],
                error_id                    = g.[Error_Id],
                application_espace_id       = g.[Espace_Id],
                application_espace_name     = g.[Espace_Name],
                import_latency              = DATEDIFF(minute, g.[Instant],GETDATE()),
                instant                     = [Instant],
                message_text                = [Message],
                message_type                = [Message_Type],
                application_module_name     = [Module_Name],
                request_key                 = [Request_Key],
                session_id                  = [Session_Id],
                tenant_id                   = g.[Tenant_Id],
                user_id                     = [User_Id],
                user_name                   = g.username
            FROM [dbo].[oslog_General] (nolock) g
            WHERE DATEDIFF(SECOND,'2020-01-01', instant) > :sql_last_value
        "
    }
}

filter {
    #------------------------------------------------------------------------------#
    # Common part
    #------------------------------------------------------------------------------#
    mutate {
        add_field => {
            "[ecs][version]" => "1.5.0"
            "[outsystems][customer_name]" => "DevOps"
            "[outsystems][location_name]" => "Linda-a-Velha"
            "[outsystems][environment_name]" => "Development"
        }

        convert => [ "instant", "string" ] # we need to convert this to a string to be able to parse it into the @timestamp field

        remove_field => [ "instant_unix" ] # this field was only used for controling the query pagination, so we don't need to keep it
    }

    date {
        match => ["instant", "ISO8601"]
        timezone => "Etc/UTC"
    }

    mutate {
        rename => { "instant" => "[log][instant]" } # the value of this field is now in the @timestamp field, so we just keep it as a control value
    }

    #------------------------------------------------------------------------------#
    # Specific part
    #------------------------------------------------------------------------------#
    fingerprint {
        source => ["[request_key]", "[instant]", "[message_text]"]
        target => "[@metadata][fingerprint]"
        method => "MURMUR3"
        concatenate_sources => true
    }

    grok {
        patterns_dir => ["/var/opt/elastic/logstash/outsystems-elastic-integration-private/logstash/patterns"]
#        patterns_dir => ["/Users/david/Developer/OutSystems/elk/logstash-7.7.0/extra/patterns"]
        match => { "message_text" => "%{SPACE}%{MESSAGE_OBJECT:[message][object]}%{SPACE}%{WORD}%{SPACE}%{NUMBER:[message][duration]}%{GREEDYDATA}" }
    }

    mutate {
        add_field => { "[log][data_source]" => "General" }

        rename => {
            "application_action_name" => "[application][action_name]"
            "application_key" => "[application][key]"
            "application_name" => "[application][name]"
            "application_entrypoint_name" => "[application][entrypoint_name]"
            "application_espace_id" => "[application][espace_id]"
            "application_espace_name" => "[application][espace_name]"
            "application_module_name" => "[application][module_name]"
            "message_text" => "[message][text]"
            "message_type" => "[message][type]"
            "message_object" => "[message][object]"
            "message_duration" => "[message][duration]"
            "message_duration_custom" => "[message][duration_custom]"
            "import_latency" => "[import][latency]"
            "request_key" => "[request][key]"
            "session_id" => "[session][id]"
        }

        convert => {
            "[message][duration_custom]" => "integer"
            "[message][duration]" => "integer"
        }
    }
}

output {
    elasticsearch {
        hosts => "localhost:9200"
        document_id => "%{[@metadata][fingerprint]}"
        ilm_enabled => true
        ilm_rollover_alias => "os-mon-log-general"
        ilm_pattern => "000001"
        ilm_policy => "os-mon-log-ilm-policy"
    }
}
